# {{ ansible_managed }}
###############################################################################
# Apache VirtualHost Configuration
# Domain: {{ item.domain }}
# User: {{ item.username }}
# PHP Version: {{ item.php_version }}
# Generated by Ansible - DO NOT EDIT MANUALLY
###############################################################################

<VirtualHost *:80>
    # Server identification
    ServerName {{ item.domain }}
    {% if item.server_alias is defined %}
    ServerAlias {{ item.server_alias }}
    {% endif %}
    ServerAdmin {{ item.server_admin | default('webmaster@' ~ item.domain) }}
    
    # Document root - User home directory
    DocumentRoot /home/{{ item.username }}/{{ vhosts_public_html_dir }}
    
    # Directory configuration
    <Directory /home/{{ item.username }}/{{ vhosts_public_html_dir }}>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted
        
        # DirectoryIndex
        DirectoryIndex index.php index.html index.htm
        
        # PHP-FPM configuration via proxy_fcgi
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/run/php-fpm/{{ item.username }}-php{{ item.php_version }}-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </Directory>
    
    # Logging
    ErrorLog {{ vhosts_log_dir }}/{{ item.domain }}-error.log
    CustomLog {{ vhosts_log_dir }}/{{ item.domain }}-access.log combined
    
    # Log level
    LogLevel {{ item.log_level | default('warn') }}
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Additional configuration
    {% if item.additional_config is defined %}
    {{ item.additional_config }}
    {% endif %}
</VirtualHost>

{% if vhosts_ssl_enabled and item.ssl_enabled | default(false) %}
###############################################################################
# SSL VirtualHost Configuration
###############################################################################

<VirtualHost *:443>
    # Server identification
    ServerName {{ item.domain }}
    {% if item.server_alias is defined %}
    ServerAlias {{ item.server_alias }}
    {% endif %}
    ServerAdmin {{ item.server_admin | default('webmaster@' ~ item.domain) }}
    
    # Document root
    DocumentRoot /home/{{ item.username }}/{{ vhosts_public_html_dir }}
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ item.ssl_cert_file | default('/etc/pki/tls/certs/localhost.crt') }}
    SSLCertificateKeyFile {{ item.ssl_key_file | default('/etc/pki/tls/private/localhost.key') }}
    {% if item.ssl_chain_file is defined %}
    SSLCertificateChainFile {{ item.ssl_chain_file }}
    {% endif %}
    
    # SSL Security
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on
    
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Directory configuration
    <Directory /home/{{ item.username }}/{{ vhosts_public_html_dir }}>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted
        
        DirectoryIndex index.php index.html index.htm
        
        # PHP-FPM configuration
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/run/php-fpm/{{ item.username }}-php{{ item.php_version }}-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </Directory>
    
    # Logging
    ErrorLog {{ vhosts_log_dir }}/{{ item.domain }}-ssl-error.log
    CustomLog {{ vhosts_log_dir }}/{{ item.domain }}-ssl-access.log combined
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>
{% endif %}

###############################################################################
# Additional Configuration Notes
###############################################################################
# 
# User: {{ item.username }}
# PHP Version: {{ item.php_version }}
# PHP-FPM Socket: /run/php-fpm/{{ item.username }}-php{{ item.php_version }}-fpm.sock
# Document Root: /home/{{ item.username }}/{{ vhosts_public_html_dir }}
# 
# To test this VirtualHost:
#   1. Add {{ item.domain }} to /etc/hosts on your client
#   2. Visit http://{{ item.domain }} in your browser
#   3. Check logs: tail -f {{ vhosts_log_dir }}/{{ item.domain }}-*.log
#
###############################################################################
