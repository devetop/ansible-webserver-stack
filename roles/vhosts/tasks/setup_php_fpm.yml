---
###############################################################################
# Setup and Verify PHP-FPM Services for Multiple PHP Versions
###############################################################################

- name: Extract unique PHP versions from vhosts_list
  ansible.builtin.set_fact:
    required_php_versions: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | map(attribute='php_version') | unique | list }}"

- name: Display required PHP versions
  ansible.builtin.debug:
    msg: "Required PHP versions: {{ required_php_versions }}"

- name: Verify PHP-FPM services exist for required versions
  ansible.builtin.stat:
    path: "/usr/sbin/php-fpm"
  register: php_fpm_binary
  failed_when: not php_fpm_binary.stat.exists

- name: Create PHP-FPM pool configurations for each user
  ansible.builtin.copy:
    content: |
      ; PHP-FPM pool for {{ item.username }} - {{ item.domain }}
      ; Generated by Ansible - VirtualHosts Role
      
      [{{ item.username }}]
      user = {{ item.username }}
      group = {{ item.username }}
      
      ; Socket configuration
      listen = /run/php-fpm/{{ item.username }}-php{{ item.php_version }}-fpm.sock
      listen.owner = apache
      listen.group = apache
      listen.mode = 0660
      
      ; Process manager configuration
      pm = dynamic
      pm.max_children = 10
      pm.start_servers = 2
      pm.min_spare_servers = 1
      pm.max_spare_servers = 3
      pm.max_requests = 500
      
      ; PHP configuration
      php_admin_value[error_log] = /var/log/php-fpm/{{ item.username }}-error.log
      php_admin_flag[log_errors] = on
      php_admin_value[memory_limit] = 256M
      php_admin_value[upload_max_filesize] = 64M
      php_admin_value[post_max_size] = 64M
      
      ; Security
      php_admin_value[open_basedir] = /home/{{ item.username }}/{{ vhosts_public_html_dir }}:/tmp:/usr/share/php
    dest: "/etc/php-fpm.d/{{ item.username }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when: item.state == 'present'
  notify: restart httpd

- name: Remove PHP-FPM pool configurations for absent VirtualHosts
  ansible.builtin.file:
    path: "/etc/php-fpm.d/{{ item.username }}.conf"
    state: absent
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'absent') | list }}"
  when: item.state == 'absent'
  notify: restart httpd

- name: Ensure PHP-FPM run directory exists
  ansible.builtin.file:
    path: /run/php-fpm
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure PHP-FPM log directory exists
  ansible.builtin.file:
    path: /var/log/php-fpm
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Start and enable PHP-FPM service
  ansible.builtin.service:
    name: php-fpm
    state: started
    enabled: true

- name: Verify PHP-FPM sockets exist for active VirtualHosts
  ansible.builtin.wait_for:
    path: "/run/php-fpm/{{ item.username }}-php{{ item.php_version }}-fpm.sock"
    timeout: 30
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when: item.state == 'present'
  register: socket_check
  failed_when: false

- name: Display PHP-FPM socket status
  ansible.builtin.debug:
    msg: "PHP-FPM socket created for {{ item.item.username }}"
  loop: "{{ socket_check.results }}"
  when: 
    - item is defined
    - not item.failed | default(false)
  loop_control:
    label: "{{ item.item.username }}"

- name: Configure SELinux for PHP-FPM sockets
  ansible.posix.seboolean:
    name: httpd_can_network_connect
    state: true
    persistent: true
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"

- name: Set SELinux context for PHP-FPM sockets
  community.general.sefcontext:
    target: "/var/run/php-fpm(/.*)?"
    setype: httpd_var_run_t
    state: present
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"

- name: Apply SELinux context to PHP-FPM socket directory
  ansible.builtin.command: "restorecon -Rv /var/run/php-fpm"
  register: selinux_restore_fpm
  changed_when: "'Relabeled' in selinux_restore_fpm.stdout"
  failed_when: false
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"

- name: Display PHP-FPM setup summary
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "PHP-FPM Configuration Summary"
      - "========================================="
      - "PHP Versions in use: {{ required_php_versions }}"
      - "Total pools configured: {{ vhosts_list | selectattr('state', 'equalto', 'present') | list | length }}"
      - "========================================="
