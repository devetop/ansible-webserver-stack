---
###############################################################################
# Configure mod_userdir for Apache
###############################################################################

- name: Ensure mod_userdir configuration exists
  ansible.builtin.copy:
    content: |
      # mod_userdir configuration
      # Generated by Ansible - VirtualHosts Role
      
      <IfModule mod_userdir.c>
          # Enable user directories
          UserDir {{ vhosts_public_html_dir }}
          
          # Disable user directory for system users
          UserDir disabled root
          
          # Directory permissions for user public_html
          <Directory "/home/*/{{ vhosts_public_html_dir }}">
              AllowOverride All
              Options -Indexes +FollowSymLinks +MultiViews
              Require all granted
          </Directory>
      </IfModule>
    dest: "{{ vhosts_apache_config_dir }}/userdir.conf"
    owner: root
    group: root
    mode: '0644'
  notify: reload httpd

- name: Create public_html directories for all VirtualHost users
  ansible.builtin.file:
    path: "/home/{{ item.username }}/{{ vhosts_public_html_dir }}"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "{{ vhosts_userdir_permissions }}"
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when: item.state == 'present'

- name: Set SELinux context for public_html directories
  community.general.sefcontext:
    target: "/home/{{ item.username }}/{{ vhosts_public_html_dir }}(/.*)?"
    setype: httpd_user_content_t
    state: present
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
    - item.state == 'present'

- name: Apply SELinux context to public_html directories
  ansible.builtin.command: "restorecon -Rv /home/{{ item.username }}/{{ vhosts_public_html_dir }}"
  register: selinux_restore
  changed_when: "'Relabeled' in selinux_restore.stdout"
  failed_when: false
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
    - item.state == 'present'

- name: Create default index.html for new VirtualHosts
  ansible.builtin.copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>{{ item.domain }} - Welcome</title>
          <style>
              body { 
                  font-family: Arial, sans-serif; 
                  margin: 50px; 
                  background: #f4f4f4;
              }
              .container {
                  background: white;
                  padding: 30px;
                  border-radius: 8px;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              h1 { color: #333; }
              .info { 
                  background: #e8f4f8; 
                  padding: 15px; 
                  border-radius: 5px;
                  margin-top: 20px;
              }
              .success { color: #28a745; font-weight: bold; }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>ðŸš€ VirtualHost Active!</h1>
              <p class="success">Your VirtualHost {{ item.domain }} is successfully configured.</p>
              
              <div class="info">
                  <p><strong>Domain:</strong> {{ item.domain }}</p>
                  <p><strong>User:</strong> {{ item.username }}</p>
                  <p><strong>Document Root:</strong> /home/{{ item.username }}/{{ vhosts_public_html_dir }}</p>
                  <p><strong>PHP Version:</strong> {{ item.php_version }}</p>
              </div>
              
              <h2>Next Steps:</h2>
              <ol>
                  <li>Upload your website files to <code>/home/{{ item.username }}/{{ vhosts_public_html_dir }}</code></li>
                  <li>Create an index.php file to test PHP functionality</li>
                  <li>Configure your DNS to point {{ item.domain }} to this server</li>
              </ol>
          </div>
      </body>
      </html>
    dest: "/home/{{ item.username }}/{{ vhosts_public_html_dir }}/index.html"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: '0644'
    force: false
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when: item.state == 'present'

- name: Create PHP info test file
  ansible.builtin.copy:
    content: |
      <?php
      // PHP Info Page - {{ item.domain }}
      echo "<h1>PHP Configuration for {{ item.domain }}</h1>";
      echo "<p><strong>PHP Version:</strong> " . phpversion() . "</p>";
      echo "<p><strong>Server:</strong> " . $_SERVER['SERVER_SOFTWARE'] . "</p>";
      echo "<hr>";
      phpinfo();
      ?>
    dest: "/home/{{ item.username }}/{{ vhosts_public_html_dir }}/info.php"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: '0644'
    force: false
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when: item.state == 'present'

- name: Set proper home directory permissions for Apache
  ansible.builtin.file:
    path: "/home/{{ item.username }}"
    mode: '0711'
  loop: "{{ vhosts_list | selectattr('state', 'equalto', 'present') | list }}"
  when: item.state == 'present'

- name: Display mod_userdir configuration status
  ansible.builtin.debug:
    msg: "mod_userdir configured successfully for {{ vhosts_list | selectattr('state', 'equalto', 'present') | list | length }} users"
